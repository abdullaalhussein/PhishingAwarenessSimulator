{% extends "base.html" %}

{% block title %}Results - {{ scenario.title }} - PhishSim{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/simulation.css') }}" rel="stylesheet">
{% endblock %}

{% block content %}
<div id="sim-container" data-session-id="{{ session.id }}" data-stage="result">

<!-- Progress Stages -->
<div class="progress-stages">
    <div class="progress-stage done" data-stage="0">
        <span class="stage-num">1</span> Briefing
    </div>
    <div class="progress-stage done" data-stage="1">
        <span class="stage-num">2</span> Scenario
    </div>
    <div class="progress-stage done" data-stage="2">
        <span class="stage-num">3</span> Red Flags
    </div>
    <div class="progress-stage active" data-stage="3">
        <span class="stage-num">4</span> Results
    </div>
</div>

<div class="sim-content fade-in">

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}">Dashboard</a></li>
        <li class="breadcrumb-item"><a href="{{ url_for('simulation.select_scenario', difficulty=scenario.difficulty) }}">{{ scenario.difficulty|capitalize }}</a></li>
        <li class="breadcrumb-item active">Results</li>
    </ol>
</nav>

<!-- Scenario Title -->
<div class="text-center mb-4">
    <h3>{{ scenario.title }}</h3>
    <span class="badge {% if scenario.difficulty == 'beginner' %}bg-success{% elif scenario.difficulty == 'intermediate' %}bg-warning text-dark{% else %}bg-danger{% endif %}">
        {{ scenario.difficulty|capitalize }}
    </span>
    <span class="badge bg-secondary">
        {% if scenario.type == 'email' %}<i class="bi bi-envelope"></i>{% elif scenario.type == 'sms' %}<i class="bi bi-chat-dots"></i>{% else %}<i class="bi bi-globe"></i>{% endif %}
        {{ scenario.type|upper }}
    </span>
</div>

<!-- Score Circle -->
<div class="text-center mb-4">
    {% set pct = (report.total_score / report.max_score * 100)|round(0)|int if report.max_score > 0 else 0 %}
    <div class="score-circle {% if pct >= 90 %}score-excellent{% elif pct >= 70 %}score-good{% elif pct >= 50 %}score-moderate{% else %}score-poor{% endif %}">
        <div class="score-value" data-target="{{ pct }}">{{ pct }}%</div>
        <div class="score-label">Score</div>
    </div>
    <p class="text-muted">{{ report.total_score|int }} / {{ report.max_score|int }} points</p>
</div>

<!-- Score Breakdown Cards -->
<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card p-3 text-center shadow-sm">
            <i class="bi bi-hand-index fs-4 text-primary"></i>
            <div class="fw-bold mt-1">Decision</div>
            <div class="text-muted small">
                {% set action_actions = [] %}
                {% for a in session.actions %}
                    {% if a.action_type.startswith('action:') %}
                        {% if a.is_correct %}
                            <span class="text-success"><i class="bi bi-check-circle-fill"></i> Correct</span>
                        {% else %}
                            <span class="text-danger"><i class="bi bi-x-circle-fill"></i> Incorrect</span>
                        {% endif %}
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 text-center shadow-sm">
            <i class="bi bi-flag fs-4 text-danger"></i>
            <div class="fw-bold mt-1">Red Flags</div>
            <div class="mt-1">
                <span class="fs-5 fw-bold">{{ report.red_flags_identified }}</span>
                <span class="text-muted">/ {{ report.red_flags_total }}</span>
            </div>
            <div class="progress mt-2" style="height: 6px;">
                <div class="progress-bar bg-danger" style="width: {{ (report.red_flags_identified / report.red_flags_total * 100)|round(0) if report.red_flags_total > 0 else 0 }}%"></div>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card p-3 text-center shadow-sm">
            <i class="bi bi-stopwatch fs-4 text-info"></i>
            <div class="fw-bold mt-1">Time Taken</div>
            <div class="fs-5 fw-bold mt-1">
                {% if report.time_taken_seconds < 60 %}
                {{ report.time_taken_seconds }}s
                {% else %}
                {{ (report.time_taken_seconds // 60) }}m {{ (report.time_taken_seconds % 60) }}s
                {% endif %}
            </div>
            <div class="text-muted small">
                {% if report.time_taken_seconds <= 60 %}
                <span class="text-success">Quick response!</span>
                {% elif report.time_taken_seconds >= 300 %}
                <span class="text-warning">Slow â€” practice makes faster</span>
                {% else %}
                Normal pace
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Feedback Summary -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-chat-square-text"></i> Feedback</h5>
    </div>
    <div class="card-body">
        {% for line in report.feedback_summary.split('\n') %}
            {% if line.strip().startswith('  - ') %}
                <div class="ms-3 text-muted small">{{ line.strip()[2:] }}</div>
            {% elif line.strip().startswith('Missed red flags:') %}
                <p class="fw-bold mt-3 mb-1 text-danger"><i class="bi bi-exclamation-triangle"></i> {{ line }}</p>
            {% elif line.strip() %}
                <p class="mb-2">{{ line }}</p>
            {% endif %}
        {% endfor %}
    </div>
</div>

<!-- Red Flags Breakdown -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-flag"></i> Red Flags Breakdown</h5>
    </div>
    <div class="card-body">
        {% for flag in scenario.red_flags %}
        <div class="red-flag-item {% if flag.label in report.feedback_summary %}{% else %}identified{% endif %}">
            <div class="flag-label">
                {% if flag.label in report.feedback_summary %}
                <i class="bi bi-x-circle text-danger"></i>
                {% else %}
                <i class="bi bi-check-circle text-success"></i>
                {% endif %}
                {{ flag.label }}
            </div>
            <div class="flag-detail">{{ flag.detail }}</div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Learning Objectives -->
<div class="card mb-4 shadow-sm">
    <div class="card-header bg-white">
        <h5 class="mb-0"><i class="bi bi-lightbulb"></i> Learning Objectives</h5>
    </div>
    <div class="card-body">
        {% for objective in scenario.learning_objectives %}
        <div class="learning-item">
            <i class="bi bi-mortarboard text-primary"></i> {{ objective }}
        </div>
        {% endfor %}
    </div>
</div>

<!-- Navigation -->
<div class="d-flex justify-content-between mb-4">
    <a href="{{ url_for('simulation.select_scenario', difficulty=scenario.difficulty) }}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Try Another Scenario
    </a>
    <a href="{{ url_for('dashboard.index') }}" class="btn btn-primary">
        <i class="bi bi-speedometer2"></i> Back to Dashboard
    </a>
</div>

</div>{# .sim-content #}
</div>{# #sim-container #}
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/simulation.js') }}"></script>
{% endblock %}
