{% extends "base.html" %}
{% block title %}Email Analyzer â€” PhishSim{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/simulation.css') }}" rel="stylesheet">
<style>
    .risk-circle {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        margin: 0 auto 20px;
        font-weight: 700;
    }
    .risk-critical { background: #f8d7da; color: #842029; border: 5px solid #dc3545; }
    .risk-high { background: #fff3cd; color: #664d03; border: 5px solid #ffc107; }
    .risk-medium { background: #cff4fc; color: #055160; border: 5px solid #0dcaf0; }
    .risk-low { background: #d1e7dd; color: #0f5132; border: 5px solid #198754; }
    .indicator-item {
        padding: 12px 16px;
        background: #fff;
        margin-bottom: 10px;
        border-radius: 0 8px 8px 0;
        transition: all 0.2s;
    }
    .indicator-item.severity-high { border-left: 4px solid #dc3545; }
    .indicator-item.severity-medium { border-left: 4px solid #ffc107; }
    .indicator-item.severity-low { border-left: 4px solid #0dcaf0; }
    .severity-badge {
        font-size: 11px;
        padding: 2px 8px;
        border-radius: 10px;
        font-weight: 600;
        text-transform: uppercase;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <h2 class="mb-1"><i class="bi bi-shield-check"></i> Email Analyzer</h2>
        <p class="text-muted mb-4">Paste a suspicious email to analyze it for phishing indicators.</p>

        <div class="card mb-4">
            <div class="card-body">
                <form method="POST" action="{{ url_for('analyzer.index') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="sender_name">Sender Name</label>
                            <input type="text" class="form-control" id="sender_name"
                                   name="sender_name" placeholder="e.g. Security Team"
                                   value="{{ form_data.get('sender_name', '') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="sender_email">Sender Email</label>
                            <input type="text" class="form-control" id="sender_email"
                                   name="sender_email" placeholder="e.g. security@n0treal.xyz"
                                   value="{{ form_data.get('sender_email', '') }}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="subject">Subject</label>
                        <input type="text" class="form-control" id="subject"
                               name="subject" placeholder="e.g. URGENT: Your account has been compromised!!!"
                               value="{{ form_data.get('subject', '') }}">
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="body">Email Body</label>
                        <textarea class="form-control" id="body" name="body" rows="8"
                                  placeholder="Paste the full email body here...">{{ form_data.get('body', '') }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="bi bi-search"></i> Analyze Email
                    </button>
                </form>
            </div>
        </div>

        {% if result %}
        <div class="fade-in">
            <h4 class="mb-3">Analysis Results</h4>

            <div class="card mb-4">
                <div class="card-body text-center">
                    <div class="risk-circle risk-{{ result.risk_level|lower }}">
                        <span style="font-size: 2.5rem; line-height: 1;">{{ result.risk_percentage|int }}%</span>
                        <span style="font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; margin-top: 2px;">Risk</span>
                    </div>
                    <span class="badge fs-6
                        {% if result.risk_level == 'Critical' %}bg-danger
                        {% elif result.risk_level == 'High' %}bg-warning text-dark
                        {% elif result.risk_level == 'Medium' %}bg-info text-dark
                        {% else %}bg-success{% endif %}">
                        {{ result.risk_level }} Risk
                    </span>
                </div>
            </div>

            {% if result.indicators %}
            <h5 class="mb-3"><i class="bi bi-exclamation-triangle"></i> Detected Indicators ({{ result.indicators|length }})</h5>
            {% for indicator in result.indicators %}
            <div class="indicator-item severity-{{ indicator.severity }}">
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <strong>{{ indicator.category }}</strong>
                    <span class="severity-badge
                        {% if indicator.severity == 'high' %}bg-danger text-white
                        {% elif indicator.severity == 'medium' %}bg-warning text-dark
                        {% else %}bg-info text-dark{% endif %}">
                        {{ indicator.severity }}
                    </span>
                </div>
                <p class="mb-1 text-muted small">{{ indicator.description }}</p>
                <code class="small">{{ indicator.evidence }}</code>
            </div>
            {% endfor %}
            {% else %}
            <div class="alert alert-success">
                <i class="bi bi-check-circle"></i> No strong phishing indicators detected. The email appears relatively safe, but always exercise caution.
            </div>
            {% endif %}

            <div class="mt-4">
                <a href="{{ url_for('analyzer.simulate') }}?from_name={{ form_data.get('sender_name', '')|urlencode }}&from_email={{ form_data.get('sender_email', '')|urlencode }}&subject={{ form_data.get('subject', '')|urlencode }}&body={{ form_data.get('body', '')|urlencode }}"
                   class="btn btn-outline-secondary">
                    <i class="bi bi-play-circle"></i> Try as Simulation
                </a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
