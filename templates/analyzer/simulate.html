{% extends "base.html" %}
{% block title %}Custom Simulation — PhishSim{% endblock %}

{% block extra_css %}
<link href="{{ url_for('static', filename='css/simulation.css') }}" rel="stylesheet">
<style>
    /* ===== Attack Panel ===== */
    .attack-panel {
        background: #1a1a2e;
        color: #e0e0e0;
        border-radius: 10px;
        padding: 24px;
        margin-top: 24px;
    }
    .attack-panel h5 { color: #ff6b6b; }
    .attack-item {
        padding: 12px 16px;
        margin-bottom: 10px;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.05);
    }
    .attack-item.severity-high { border-left: 4px solid #dc3545; }
    .attack-item.severity-medium { border-left: 4px solid #ffc107; }
    .attack-item.severity-low { border-left: 4px solid #0dcaf0; }

    /* ===== Link Warning Overlay ===== */
    .link-warning-overlay {
        display: none;
        position: fixed;
        top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6);
        z-index: 9999;
        align-items: center;
        justify-content: center;
    }
    .link-warning-overlay.show { display: flex; }
    .link-warning-box {
        background: #fff;
        border-radius: 12px;
        padding: 30px;
        max-width: 450px;
        text-align: center;
        box-shadow: 0 8px 30px rgba(0,0,0,0.3);
    }

    /* ===== Delivery Progress Bar ===== */
    .delivery-progress {
        display: flex;
        gap: 0;
        margin-bottom: 24px;
        background: #1a1a2e;
        border-radius: 10px;
        overflow: hidden;
    }
    .delivery-step {
        flex: 1;
        text-align: center;
        padding: 14px 8px;
        font-size: 13px;
        font-weight: 600;
        color: #555;
        background: #0d1117;
        border-right: 1px solid #1a1a2e;
        transition: all 0.4s ease;
        position: relative;
    }
    .delivery-step:last-child { border-right: none; }
    .delivery-step i { display: block; font-size: 1.3rem; margin-bottom: 4px; }
    .delivery-step.active {
        color: #58a6ff;
        background: #161b22;
    }
    .delivery-step.active i { animation: pulse 1.2s infinite; }
    .delivery-step.done {
        color: #3fb950;
        background: #0d1117;
    }

    /* ===== Network Terminal ===== */
    .network-terminal {
        background: #0d1117;
        color: #c9d1d9;
        font-family: 'Courier New', 'Consolas', monospace;
        font-size: 13px;
        padding: 16px;
        border-radius: 10px;
        height: 380px;
        overflow-y: auto;
        border: 1px solid #30363d;
        line-height: 1.6;
    }
    .network-terminal::-webkit-scrollbar { width: 6px; }
    .network-terminal::-webkit-scrollbar-track { background: #0d1117; }
    .network-terminal::-webkit-scrollbar-thumb { background: #30363d; border-radius: 3px; }
    .network-line { white-space: pre-wrap; word-break: break-all; }
    .network-line.client { color: #58a6ff; }
    .network-line.server { color: #3fb950; }
    .network-line.system { color: #d29922; }
    .network-cursor {
        display: inline-block;
        width: 8px;
        height: 14px;
        background: #c9d1d9;
        animation: blink 1s step-end infinite;
        vertical-align: middle;
    }
    @keyframes blink {
        50% { opacity: 0; }
    }

    /* ===== Stage Visual Panel ===== */
    .stage-visual {
        background: #0d1117;
        border: 1px solid #30363d;
        border-radius: 10px;
        height: 380px;
        display: flex;
        align-items: center;
        justify-content: center;
        flex-direction: column;
        color: #c9d1d9;
        text-align: center;
        padding: 24px;
        position: relative;
        overflow: hidden;
    }
    .stage-visual .stage-icon {
        font-size: 3.5rem;
        margin-bottom: 16px;
        transition: all 0.4s ease;
    }
    .stage-visual .stage-label {
        font-size: 1rem;
        font-weight: 600;
        color: #8b949e;
    }
    .stage-visual .stage-detail {
        font-size: 0.85rem;
        color: #484f58;
        margin-top: 6px;
    }
    .stage-visual.dns .stage-icon { color: #d29922; }
    .stage-visual.smtp .stage-icon { color: #58a6ff; }
    .stage-visual.data .stage-icon { color: #bc8cff; }
    .stage-visual.done .stage-icon { color: #3fb950; }

    /* ===== Envelope flying animation ===== */
    @keyframes fly-envelope {
        0% { transform: translateX(-60px) translateY(20px) scale(0.8); opacity: 0; }
        30% { transform: translateX(0) translateY(-10px) scale(1); opacity: 1; }
        70% { transform: translateX(40px) translateY(-5px) scale(1); opacity: 1; }
        100% { transform: translateX(60px) translateY(20px) scale(0.8); opacity: 0; }
    }
    .envelope-fly {
        animation: fly-envelope 2s ease-in-out infinite;
    }

    @keyframes radar-ping {
        0% { transform: scale(1); opacity: 0.6; }
        100% { transform: scale(2.5); opacity: 0; }
    }
    .radar-ring {
        position: absolute;
        width: 80px; height: 80px;
        border: 2px solid #58a6ff;
        border-radius: 50%;
        animation: radar-ping 1.5s ease-out infinite;
    }

    /* ===== Inbox Mockup ===== */
    .inbox-mockup {
        background: #fff;
        border-radius: 10px;
        overflow: hidden;
        border: 1px solid #ddd;
        box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        margin-top: 24px;
    }
    .inbox-toolbar {
        background: #f6f8fa;
        border-bottom: 1px solid #e1e4e8;
        padding: 10px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 14px;
        font-weight: 600;
        color: #333;
    }
    .inbox-toolbar i { color: #666; }
    .inbox-row {
        display: flex;
        align-items: center;
        padding: 12px 16px;
        border-bottom: 1px solid #f0f0f0;
        font-size: 14px;
        color: #666;
        transition: background 0.2s;
    }
    .inbox-row:last-child { border-bottom: none; }
    .inbox-row .inbox-sender {
        width: 180px;
        font-weight: 400;
        color: #555;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .inbox-row .inbox-subject {
        flex: 1;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .inbox-row .inbox-time {
        width: 70px;
        text-align: right;
        font-size: 12px;
        color: #999;
    }
    .inbox-row.new-email {
        background: #f0f6ff;
        font-weight: 600;
        color: #1a1a1a;
        cursor: pointer;
        border-left: 4px solid #0d6efd;
    }
    .inbox-row.new-email:hover { background: #e3edfc; }
    .inbox-row.new-email .inbox-sender { font-weight: 700; color: #1a1a1a; }
    .new-badge {
        display: inline-block;
        background: #0d6efd;
        color: #fff;
        font-size: 10px;
        font-weight: 700;
        padding: 2px 7px;
        border-radius: 10px;
        margin-right: 8px;
        text-transform: uppercase;
    }
    .inbox-notification {
        animation: slideDown 0.5s ease-out;
    }
    @keyframes slideDown {
        from { opacity: 0; transform: translateY(-20px); }
        to { opacity: 1; transform: translateY(0); }
    }

    /* ===== Section transitions ===== */
    .sim-section { display: none; }
    .sim-section.visible { display: block; animation: fadeIn 0.5s ease-out; }

    /* ===== Notification bell ===== */
    @keyframes ring-bell {
        0% { transform: rotate(0); }
        10% { transform: rotate(14deg); }
        20% { transform: rotate(-14deg); }
        30% { transform: rotate(10deg); }
        40% { transform: rotate(-10deg); }
        50% { transform: rotate(6deg); }
        60% { transform: rotate(-4deg); }
        70% { transform: rotate(2deg); }
        80% { transform: rotate(-1deg); }
        100% { transform: rotate(0); }
    }
    .bell-ring { animation: ring-bell 0.8s ease; }

    /* ===== Example Library ===== */
    .example-library .card-header {
        background: #1a1a2e;
        color: #e0e0e0;
        cursor: pointer;
    }
    .example-library .card-header:hover { background: #22223a; }
    .example-card {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 16px;
        transition: transform 0.2s, box-shadow 0.2s;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .example-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .example-card.difficulty-beginner { border-left: 4px solid #198754; }
    .example-card.difficulty-intermediate { border-left: 4px solid #ffc107; }
    .example-card.difficulty-advanced { border-left: 4px solid #dc3545; }
    .difficulty-tabs .nav-link {
        color: #6c757d;
        font-weight: 600;
        border: none;
        border-bottom: 3px solid transparent;
        border-radius: 0;
        padding: 8px 16px;
    }
    .difficulty-tabs .nav-link.active-beginner { color: #198754; border-bottom-color: #198754; }
    .difficulty-tabs .nav-link.active-intermediate { color: #856404; border-bottom-color: #ffc107; }
    .difficulty-tabs .nav-link.active-advanced { color: #dc3545; border-bottom-color: #dc3545; }

    /* ===== Beginner Guide ===== */
    .guide-panel {
        background: #f0f7ff;
        border: 1px solid #b6d4fe;
        border-radius: 10px;
    }
    .guide-panel .card-header {
        background: #d0e7ff;
        color: #0a58ca;
        cursor: pointer;
    }
    .guide-panel .card-header:hover { background: #bdd8fc; }
    .guide-step {
        background: #fff;
        border: 1px solid #d0e7ff;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        position: relative;
        padding-left: 56px;
    }
    .guide-step .step-number {
        position: absolute;
        left: 14px;
        top: 14px;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        background: #0d6efd;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 14px;
    }
    .guide-step h6 { margin-bottom: 6px; }
    .red-flag-tag {
        display: inline-block;
        background: #fff3cd;
        color: #664d03;
        font-size: 11px;
        font-weight: 600;
        padding: 2px 8px;
        border-radius: 10px;
        margin-top: 6px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-10 mx-auto">
        <div class="d-flex align-items-center mb-1">
            <h2 class="me-3 mb-0"><i class="bi bi-envelope-paper"></i> Custom Simulation Builder</h2>
            <a href="{{ url_for('analyzer.index') }}" class="btn btn-sm btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Analyzer
            </a>
        </div>
        <p class="text-muted mb-4">Build a phishing scenario and see how it would look in a real email client.</p>

        <!-- ===== EXAMPLE LIBRARY ===== -->
        <div class="card example-library mb-4" id="exampleLibrary">
            <div class="card-header d-flex align-items-center justify-content-between" id="exampleLibraryToggle">
                <span><i class="bi bi-grid-3x3-gap-fill me-2"></i><strong>Example Scenarios</strong></span>
                <i class="bi bi-chevron-down" id="exampleChevron"></i>
            </div>
            <div class="card-body {{ '' if user_role == 'instructor' else 'd-none' }}" id="exampleLibraryBody">
                <ul class="nav difficulty-tabs mb-3" id="difficultyTabs">
                    <li class="nav-item">
                        <button class="nav-link active-beginner active" data-difficulty="Beginner" type="button">Beginner</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-difficulty="Intermediate" type="button">Intermediate</button>
                    </li>
                    <li class="nav-item">
                        <button class="nav-link" data-difficulty="Advanced" type="button">Advanced</button>
                    </li>
                </ul>
                <div class="row g-3" id="exampleGrid">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        {% if user_role == 'student' %}
        <!-- ===== BEGINNER GUIDE ===== -->
        <div class="card guide-panel mb-4" id="beginnerGuide">
            <div class="card-header d-flex align-items-center justify-content-between" id="guideToggle">
                <span><i class="bi bi-lightbulb-fill me-2"></i><strong>How to Build a Phishing Email</strong></span>
                <i class="bi bi-chevron-down" id="guideChevron"></i>
            </div>
            <div class="card-body" id="guideBody">
                <div class="guide-step">
                    <div class="step-number">1</div>
                    <h6>Pick a Sender Identity</h6>
                    <p class="text-muted small mb-1">Use a fake organization name and a lookalike domain. Try substituting letters with numbers (<code>paypa1.com</code>, <code>amaz0n.com</code>) or use uncommon TLDs (<code>.xyz</code>, <code>.top</code>, <code>.co</code>).</p>
                    <span class="red-flag-tag"><i class="bi bi-flag-fill me-1"></i>Suspicious Sender Domain</span>
                </div>
                <div class="guide-step">
                    <div class="step-number">2</div>
                    <h6>Choose Your Target</h6>
                    <p class="text-muted small mb-1">Enter a realistic victim email address. Think about who would be vulnerable to this type of attack — employees, students, or specific departments like accounting.</p>
                    <span class="red-flag-tag"><i class="bi bi-flag-fill me-1"></i>Targeted Recipient</span>
                </div>
                <div class="guide-step">
                    <div class="step-number">3</div>
                    <h6>Write an Urgent Subject Line</h6>
                    <p class="text-muted small mb-1">Create pressure with phrases like "URGENT:", "Action Required:", or "Your account will be suspended". Use caps and punctuation sparingly for realism.</p>
                    <span class="red-flag-tag"><i class="bi bi-flag-fill me-1"></i>Urgency &amp; Pressure Tactics</span>
                </div>
                <div class="guide-step">
                    <div class="step-number">4</div>
                    <h6>Craft the Email Body</h6>
                    <p class="text-muted small mb-1">Include a generic greeting, urgency or threats, a call-to-action link (<code>&lt;a href="http://evil.com"&gt;Click here&lt;/a&gt;</code>), and a fake signature. HTML tags like <code>&lt;b&gt;</code>, <code>&lt;p&gt;</code>, <code>&lt;ul&gt;</code> are supported.</p>
                    <span class="red-flag-tag"><i class="bi bi-flag-fill me-1"></i>Suspicious Links &amp; Content</span>
                </div>
                <div class="guide-step">
                    <div class="step-number">5</div>
                    <h6>Send &amp; Analyze</h6>
                    <p class="text-muted small mb-1">Click "Send &amp; Simulate" to watch the SMTP delivery animation, see how the email looks in an inbox, and review the attack vectors the system detects.</p>
                    <span class="red-flag-tag"><i class="bi bi-flag-fill me-1"></i>Detection &amp; Analysis</span>
                </div>
                <div class="text-center mt-3">
                    <button class="btn btn-primary" type="button" id="tryItNowBtn">
                        <i class="bi bi-lightning-fill me-1"></i>Try it now! — Load a beginner example
                    </button>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- ===== BUILD FORM ===== -->
        <div class="card mb-4" id="buildForm">
            <div class="card-body">
                <form method="POST" action="{{ url_for('analyzer.simulate') }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="from_name">From Name</label>
                            <input type="text" class="form-control" id="from_name"
                                   name="from_name" placeholder="e.g. IT Support"
                                   value="{{ form_data.get('from_name', '') or request.args.get('from_name', '') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="from_email">From Email</label>
                            <input type="text" class="form-control" id="from_email"
                                   name="from_email" placeholder="e.g. support@c0mpany-help.xyz"
                                   value="{{ form_data.get('from_email', '') or request.args.get('from_email', '') }}">
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label" for="to_email">To Email</label>
                            <input type="text" class="form-control" id="to_email"
                                   name="to_email" placeholder="e.g. employee@university.edu"
                                   value="{{ form_data.get('to_email', '') }}">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label" for="subject">Subject</label>
                            <input type="text" class="form-control" id="subject"
                                   name="subject" placeholder="e.g. Action Required: Verify Your Account"
                                   value="{{ form_data.get('subject', '') or request.args.get('subject', '') }}">
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label" for="body">Email Body (HTML allowed)</label>
                        <textarea class="form-control" id="body" name="body" rows="8"
                                  placeholder="Write the email body here... HTML tags like <a>, <p>, <b> are supported.">{{ form_data.get('body', '') or request.args.get('body', '') }}</textarea>
                    </div>

                    <button type="submit" class="btn btn-danger btn-lg">
                        <i class="bi bi-send-fill"></i> Send &amp; Simulate
                    </button>
                </form>
            </div>
        </div>

        {% if preview %}
        <!-- ===== PHASE 1: NETWORK ANIMATION ===== -->
        <div id="networkSection" class="sim-section visible">
            <!-- Delivery Progress Bar -->
            <div class="delivery-progress" id="deliveryProgress">
                <div class="delivery-step" id="step-dns" data-stage="dns">
                    <i class="bi bi-globe2"></i> DNS Lookup
                </div>
                <div class="delivery-step" id="step-smtp" data-stage="smtp">
                    <i class="bi bi-hdd-network"></i> SMTP Connect
                </div>
                <div class="delivery-step" id="step-data" data-stage="data">
                    <i class="bi bi-file-earmark-arrow-up"></i> Transmit Data
                </div>
                <div class="delivery-step" id="step-done" data-stage="done">
                    <i class="bi bi-check-circle"></i> Delivered
                </div>
            </div>

            <!-- Two-column: Terminal + Stage Visual -->
            <div class="row g-3">
                <div class="col-md-7">
                    <div class="network-terminal" id="networkTerminal">
                        <span class="network-cursor" id="terminalCursor"></span>
                    </div>
                </div>
                <div class="col-md-5">
                    <div class="stage-visual" id="stageVisual">
                        <div class="stage-icon"><i class="bi bi-hourglass-split"></i></div>
                        <div class="stage-label">Waiting to start...</div>
                        <div class="stage-detail">Preparing simulation</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ===== PHASE 2: INBOX VIEW ===== -->
        <div id="inboxSection" class="sim-section">
            <div class="d-flex align-items-center mb-3">
                <h4 class="mb-0 me-2"><i class="bi bi-bell-fill bell-ring text-primary"></i> New Email Received</h4>
            </div>
            <div class="inbox-mockup">
                <div class="inbox-toolbar">
                    <i class="bi bi-envelope"></i> Inbox
                    <span class="text-muted fw-normal" style="font-size:12px; margin-left:auto;">3 messages</span>
                </div>
                <!-- Phishing email (new) -->
                <div class="inbox-row new-email inbox-notification" id="phishingInboxRow">
                    <div class="inbox-sender"><span class="new-badge">New</span>{{ preview.from_name }}</div>
                    <div class="inbox-subject">{{ preview.subject }}</div>
                    <div class="inbox-time">Just now</div>
                </div>
                <!-- Fake existing emails for realism -->
                <div class="inbox-row">
                    <div class="inbox-sender">Google Security</div>
                    <div class="inbox-subject">Your sign-in activity — New device detected</div>
                    <div class="inbox-time">2h ago</div>
                </div>
                <div class="inbox-row">
                    <div class="inbox-sender">Canvas LMS</div>
                    <div class="inbox-subject">Assignment "Week 8 Lab" graded</div>
                    <div class="inbox-time">5h ago</div>
                </div>
            </div>
            <p class="text-muted small mt-2"><i class="bi bi-hand-index"></i> Click the new email to open it.</p>
        </div>

        <!-- ===== PHASE 3: EMAIL VIEW + ATTACK PANEL ===== -->
        <div id="emailSection" class="sim-section">
            <h4 class="mb-3">Email Preview</h4>

            <!-- Realistic email client mockup -->
            <div class="email-client">
                <div class="email-toolbar">
                    <span class="email-toolbar-btn"><i class="bi bi-arrow-90deg-left"></i> Reply</span>
                    <span class="email-toolbar-btn"><i class="bi bi-arrow-90deg-right"></i> Forward</span>
                    <span class="email-toolbar-btn"><i class="bi bi-trash"></i> Delete</span>
                    <span class="email-toolbar-btn"><i class="bi bi-flag"></i> Flag</span>
                </div>
                <div class="email-header-section">
                    <div class="email-subject-line">{{ preview.subject }}</div>
                    <div class="email-sender-row">
                        <div class="email-avatar">{{ preview.avatar_letter }}</div>
                        <div class="email-sender-info">
                            <div class="email-sender-name">{{ preview.from_name }}</div>
                            <div class="email-sender-addr">&lt;{{ preview.from_email }}&gt;</div>
                            <div class="email-to-line">To: {{ preview.to_email }}</div>
                        </div>
                        <div class="email-timestamp">Just now</div>
                    </div>
                </div>
                <div class="email-body-section" id="email-body-content">
                    {{ preview.body|safe }}
                </div>
            </div>

            <!-- Attack Explanation Panel -->
            {% if attack_explanation is not none %}
            <div class="attack-panel">
                <h5><i class="bi bi-exclamation-octagon"></i> Attack Vector Analysis</h5>
                <p class="small mb-3">
                    Risk Level:
                    <span class="badge
                        {% if preview.risk_level == 'Critical' %}bg-danger
                        {% elif preview.risk_level == 'High' %}bg-warning text-dark
                        {% elif preview.risk_level == 'Medium' %}bg-info text-dark
                        {% else %}bg-success{% endif %}">
                        {{ preview.risk_level }} ({{ preview.risk_percentage|int }}%)
                    </span>
                </p>

                {% if attack_explanation is iterable and attack_explanation is not string %}
                    {% for item in attack_explanation %}
                    <div class="attack-item severity-{{ item.severity }}">
                        <strong>{{ item.category }}</strong>
                        <p class="mb-0 small" style="color: #bbb;">{{ item.explanation }}</p>
                    </div>
                    {% endfor %}
                {% else %}
                    <p>{{ attack_explanation }}</p>
                {% endif %}
            </div>
            {% endif %}
        </div>

        <!-- Link warning popup -->
        <div class="link-warning-overlay" id="linkWarning">
            <div class="link-warning-box">
                <i class="bi bi-exclamation-triangle-fill text-danger" style="font-size: 3rem;"></i>
                <h4 class="mt-3 text-danger">Phishing Link Detected!</h4>
                <p class="text-muted">In a real attack, clicking this link would take you to a malicious page designed to steal your credentials or install malware.</p>
                <p class="small"><strong>Link target:</strong> <code id="linkTarget"></code></p>
                <button class="btn btn-primary" onclick="document.getElementById('linkWarning').classList.remove('show')">
                    I Understand
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Examples data & library/guide logic (always present) -->
<script id="examplesData" type="application/json">{{ examples|safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var examples = JSON.parse(document.getElementById('examplesData').textContent);
    var currentDifficulty = 'Beginner';
    var grid = document.getElementById('exampleGrid');
    var libraryBody = document.getElementById('exampleLibraryBody');
    var libraryToggle = document.getElementById('exampleLibraryToggle');
    var chevron = document.getElementById('exampleChevron');

    // ── Render example cards for a given difficulty ──
    function renderExamples(difficulty) {
        grid.innerHTML = '';
        examples.forEach(function(ex, idx) {
            if (ex.difficulty !== difficulty) return;
            var diffClass = 'difficulty-' + ex.difficulty.toLowerCase();
            var badgeBg = ex.difficulty === 'Beginner' ? 'bg-success' :
                          ex.difficulty === 'Intermediate' ? 'bg-warning text-dark' : 'bg-danger';
            var col = document.createElement('div');
            col.className = 'col-md-6 col-lg-4';
            col.innerHTML =
                '<div class="example-card ' + diffClass + '">' +
                    '<div class="mb-2"><span class="badge ' + badgeBg + '">' + ex.difficulty + '</span></div>' +
                    '<h6 class="mb-1">' + ex.title + '</h6>' +
                    '<p class="text-muted small flex-grow-1">' + ex.description + '</p>' +
                    '<button class="btn btn-sm btn-outline-primary mt-auto load-example-btn" data-index="' + idx + '">' +
                        '<i class="bi bi-box-arrow-in-down me-1"></i>Load Example' +
                    '</button>' +
                '</div>';
            grid.appendChild(col);
        });
    }

    // ── Load an example into the form fields ──
    function loadExample(index) {
        var ex = examples[index];
        if (!ex) return;
        document.getElementById('from_name').value = ex.from_name;
        document.getElementById('from_email').value = ex.from_email;
        document.getElementById('to_email').value = ex.to_email;
        document.getElementById('subject').value = ex.subject;
        document.getElementById('body').value = ex.body;

        // Expand form if it was collapsed after POST
        var formCardBody = document.querySelector('#buildForm > .card-body');
        if (formCardBody && formCardBody.style.display === 'none') {
            formCardBody.style.display = '';
        }

        // Smooth-scroll to the form
        document.getElementById('buildForm').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    // ── Difficulty tab switching ──
    var tabs = document.querySelectorAll('#difficultyTabs .nav-link');
    tabs.forEach(function(tab) {
        tab.addEventListener('click', function() {
            tabs.forEach(function(t) {
                t.classList.remove('active', 'active-beginner', 'active-intermediate', 'active-advanced');
            });
            var diff = tab.getAttribute('data-difficulty');
            tab.classList.add('active', 'active-' + diff.toLowerCase());
            currentDifficulty = diff;
            renderExamples(diff);
        });
    });

    // ── Collapse / expand example library ──
    libraryToggle.addEventListener('click', function() {
        libraryBody.classList.toggle('d-none');
        chevron.classList.toggle('bi-chevron-down');
        chevron.classList.toggle('bi-chevron-up');
    });

    // ── Delegate clicks on "Load Example" buttons ──
    grid.addEventListener('click', function(e) {
        var btn = e.target.closest('.load-example-btn');
        if (btn) {
            loadExample(parseInt(btn.getAttribute('data-index'), 10));
        }
    });

    // ── Beginner guide toggle (students only) ──
    var guideToggle = document.getElementById('guideToggle');
    var guideBody = document.getElementById('guideBody');
    var guideChevron = document.getElementById('guideChevron');
    if (guideToggle && guideBody) {
        guideToggle.addEventListener('click', function() {
            guideBody.classList.toggle('d-none');
            if (guideChevron) {
                guideChevron.classList.toggle('bi-chevron-down');
                guideChevron.classList.toggle('bi-chevron-up');
            }
        });
    }

    // ── "Try it now!" button — load first beginner example ──
    var tryBtn = document.getElementById('tryItNowBtn');
    if (tryBtn) {
        tryBtn.addEventListener('click', function() {
            // Find the first beginner example
            for (var i = 0; i < examples.length; i++) {
                if (examples[i].difficulty === 'Beginner') {
                    loadExample(i);
                    break;
                }
            }
        });
    }

    // Initial render
    renderExamples(currentDifficulty);
});
</script>

{% if preview %}
<script id="networkLogData" type="application/json">{{ network_log|safe }}</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    var networkLog = JSON.parse(document.getElementById('networkLogData').textContent);
    var terminal = document.getElementById('networkTerminal');
    var cursor = document.getElementById('terminalCursor');
    var stageVisual = document.getElementById('stageVisual');
    var currentStage = null;

    var stageConfig = {
        dns: {
            icon: 'bi-globe2',
            label: 'DNS Resolution',
            detail: 'Looking up mail server address...',
            animClass: ''
        },
        smtp: {
            icon: 'bi-hdd-network',
            label: 'SMTP Handshake',
            detail: 'Establishing connection to mail server...',
            animClass: ''
        },
        data: {
            icon: 'bi-envelope-arrow-up',
            label: 'Transmitting Email',
            detail: 'Sending headers and body data...',
            animClass: 'envelope-fly'
        },
        done: {
            icon: 'bi-mailbox2',
            label: 'Delivered!',
            detail: 'Email arrived in victim\'s inbox',
            animClass: ''
        }
    };

    function setStageVisual(stage) {
        var cfg = stageConfig[stage];
        if (!cfg) return;
        stageVisual.className = 'stage-visual ' + stage;

        var html = '';
        if (stage === 'smtp') {
            html += '<div class="radar-ring"></div>';
        }
        html += '<div class="stage-icon ' + cfg.animClass + '"><i class="bi ' + cfg.icon + '"></i></div>';
        html += '<div class="stage-label">' + cfg.label + '</div>';
        html += '<div class="stage-detail">' + cfg.detail + '</div>';
        stageVisual.innerHTML = html;
    }

    function setProgressStep(stage) {
        var steps = document.querySelectorAll('.delivery-step');
        var stages = ['dns', 'smtp', 'data', 'done'];
        var targetIdx = stages.indexOf(stage);
        steps.forEach(function(step, idx) {
            step.classList.remove('active', 'done');
            if (idx < targetIdx) {
                step.classList.add('done');
            } else if (idx === targetIdx) {
                step.classList.add('active');
            }
        });
    }

    function addLine(entry) {
        var line = document.createElement('div');
        line.className = 'network-line ' + entry.direction;

        var prefix = '';
        if (entry.direction === 'client') prefix = 'C: ';
        else if (entry.direction === 'server') prefix = 'S: ';

        line.textContent = prefix + entry.line;

        terminal.insertBefore(line, cursor);
        terminal.scrollTop = terminal.scrollHeight;
    }

    function playAnimation(index) {
        if (index >= networkLog.length) {
            onAnimationComplete();
            return;
        }

        var entry = networkLog[index];

        if (entry.stage !== currentStage) {
            currentStage = entry.stage;
            setProgressStep(currentStage);
            setStageVisual(currentStage);
        }

        addLine(entry);

        setTimeout(function() {
            playAnimation(index + 1);
        }, entry.delay);
    }

    function onAnimationComplete() {
        // Mark final step done
        document.getElementById('step-done').classList.remove('active');
        document.getElementById('step-done').classList.add('done');

        // Remove cursor
        if (cursor) cursor.style.display = 'none';

        // Update stage visual to delivered
        stageVisual.className = 'stage-visual done';
        stageVisual.innerHTML =
            '<div class="stage-icon" style="color:#3fb950;"><i class="bi bi-check-circle-fill"></i></div>' +
            '<div class="stage-label" style="color:#3fb950;">Delivery Complete</div>' +
            '<div class="stage-detail">Check the inbox below</div>';

        // Show inbox after a short pause
        setTimeout(function() {
            document.getElementById('inboxSection').classList.add('visible');
            // Smooth scroll to inbox
            document.getElementById('inboxSection').scrollIntoView({ behavior: 'smooth', block: 'center' });
        }, 800);
    }

    // Inbox row click → open email
    var inboxRow = document.getElementById('phishingInboxRow');
    if (inboxRow) {
        inboxRow.addEventListener('click', function() {
            document.getElementById('inboxSection').style.display = 'none';
            document.getElementById('emailSection').classList.add('visible');
            document.getElementById('emailSection').scrollIntoView({ behavior: 'smooth', block: 'start' });
            setupLinkInterception();
        });
    }

    // Link interception in email body
    function setupLinkInterception() {
        var emailBody = document.getElementById('email-body-content');
        if (emailBody) {
            emailBody.querySelectorAll('a').forEach(function(link) {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    var target = link.getAttribute('href') || link.textContent;
                    document.getElementById('linkTarget').textContent = target;
                    document.getElementById('linkWarning').classList.add('show');
                });
                link.style.cursor = 'pointer';
                link.style.textDecoration = 'underline';
                link.style.color = '#0d6efd';
            });
        }
    }

    // Collapse the form on POST (it already submitted)
    var buildForm = document.getElementById('buildForm');
    if (buildForm) {
        var cardBody = buildForm.querySelector('.card-body');
        var toggleBtn = document.createElement('button');
        toggleBtn.className = 'btn btn-sm btn-outline-secondary ms-auto';
        toggleBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit Scenario';
        toggleBtn.type = 'button';

        var cardHeader = document.createElement('div');
        cardHeader.className = 'd-flex align-items-center p-3';
        cardHeader.innerHTML = '<strong class="text-muted"><i class="bi bi-check-circle text-success"></i> Scenario submitted</strong>';
        cardHeader.appendChild(toggleBtn);

        cardBody.style.display = 'none';
        buildForm.insertBefore(cardHeader, cardBody);

        toggleBtn.addEventListener('click', function() {
            if (cardBody.style.display === 'none') {
                cardBody.style.display = '';
                toggleBtn.innerHTML = '<i class="bi bi-chevron-up"></i> Hide';
            } else {
                cardBody.style.display = 'none';
                toggleBtn.innerHTML = '<i class="bi bi-pencil-square"></i> Edit Scenario';
            }
        });
    }

    // Start the animation
    setTimeout(function() {
        playAnimation(0);
    }, 500);
});
</script>
{% endif %}
{% endblock %}
